# 📄 Copy Activity Pipeline Documentation

## Overview

This document outlines the setup and process for automating the transfer of files from an **SFTP server** (where files are generated by an **Azure Function**) to **Azure Blob Storage** using **Azure Data Factory (ADF)**. After the copy process, the source files are deleted from the SFTP server to maintain storage hygiene.

---

## 🧩 Basic Cycle

<!-- Practice\Copy Activity\images\CopyActivity.png -->
![Basic Cycle Overview](Practice/Copy Activity/images/CopyActivity.png)
### 1. Azure Function
- **Purpose**: Generates files and stores them on the SFTP server.
- **Trigger**: Timer-based or HTTP/event trigger.
- **Output Format**: CSV/JSON/XML
- **Output Path**: `/outgoing-data/`

### 2. SFTP Server
- **Directory**: `/outgoing-data/`
- **Access**: Secured via SSH with credentials managed in **Azure Key Vault**
- **Lifecycle**: Files are removed after being successfully copied to Azure Blob Storage

### 3. Azure Blob Storage
- **Container**: `raw-data`
- **Access**: Secured via **Managed Identity** or **Key Vault**
- **Usage**: Acts as the raw layer in the data lake for downstream processing

---

## 🔗 Linked Services Configuration

### 🔹 SFTP Linked Service
- **Type**: SFTP
- **Authentication**: Username & SSH key stored in Azure Key Vault
- **Host**: `sftp.partnerdomain.com`
- **Port**: `22`

### 🔹 Azure Blob Storage Linked Service
- **Type**: Azure Blob Storage
- **Authentication**: Managed Identity or Key Vault
- **Container**: `raw-data`

---

## 🔄 Pipeline: `CopySFTPToBlobAndCleanup`

### 🔸 Activities

1. #### Lookup New Files
   - **Type**: `Lookup`
   - **Description**: Retrieves list of files in `/outgoing-data/` directory on SFTP
   - **Output**: Array of file paths

2. #### ForEach (Iterates over files)
   For each file found by the Lookup activity:

   - **Copy Data**
     - **Source**: SFTP `/outgoing-data/{filename}`
     - **Sink**: Azure Blob Storage `raw-data/{filename}`
     - **Options**: Binary copy, preserve file name, retry on failure
     - **Retry Policy**: 3 attempts

   - **Delete File (Post Copy)**
     - **Type**: `Delete`
     - **Condition**: Executed only if the copy succeeds
     - **Target**: SFTP `/outgoing-data/{filename}`

---

## ✅ Monitoring & Alerts

- **Pipeline Monitoring**: Handled via ADF Monitor UI
- **Logging**: Enabled through integration with **Azure Log Analytics**
- **Alerts**: Configured via **Azure Monitor** for failures and retry exhaustion

---

## 🔐 Security

- **Secrets Management**: All credentials and keys are stored securely in **Azure Key Vault**
- **Access Control**: Role-based access to ADF and Blob Storage via **Azure RBAC**
- **Audit Logs**: Available in Azure Activity Logs and Log Analytics

---

## 🕒 Scheduling

- **Trigger Type**: `Schedule Trigger`
- **Frequency**: Daily at `01:00 UTC`
- **Dependency Check**: Ensures Azure Function completes file generation before pipeline start

---

## 🧹 Cleanup & Retention

- **SFTP Cleanup**: Files are deleted from SFTP after successful copy
- **Blob Retention**: Files retained in Azure Blob Storage as per data governance (e.g., 90 days)
- **Optional**: Blob lifecycle rules for archiving or deletion

---

## 📌 Additional Notes

- Ensure consistent naming and timestamps to avoid duplicate copies
- Optionally integrate with a metadata store (e.g., Azure SQL DB) to track processed files
- Blob access tiers (Hot/Cool/Archive) can be configured based on frequency of access

---

## 📁 Folder Structure

```text
SFTP
└── /outgoing-data/
    ├── report_20250501.csv
    ├── report_20250502.csv
    └── ...
![ADF Pipeline Overview](./images/adf_sftp_to_blob.png)
